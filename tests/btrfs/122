#! /bin/bash
# SPDX-License-Identifier: GPL-2.0
# Copyright (C) 2016 SUSE Linux Products GmbH. All Rights Reserved.
#
# FS QA Test No. btrfs/122
#
# Test that qgroup counts are valid after snapshot creation. This has
# been broken in btrfs since Linux v4.1
#
. ./common/preamble
_begin_fstest auto quick snapshot qgroup

# Import common functions.
. ./common/filter

# real QA test starts here
_supported_fs btrfs
_require_scratch
_require_btrfs_qgroup_report

# Force a small leaf size to make it easier to blow out our root
# subvolume tree
_scratch_mkfs "--nodesize 16384" >/dev/null
_scratch_mount
_run_btrfs_util_prog quota enable $SCRATCH_MNT

mkdir "$SCRATCH_MNT/snaps"

# First make some simple snapshots - the bug was initially reproduced like this
_run_btrfs_util_prog subvolume snapshot $SCRATCH_MNT "$SCRATCH_MNT/snaps/empty1"
_run_btrfs_util_prog subvolume snapshot $SCRATCH_MNT "$SCRATCH_MNT/snaps/empty2"

# This forces the fs tree out past level 0, adding at least one tree
# block which must be properly accounted for when we make our next
# snapshots.
mkdir "$SCRATCH_MNT/data"
for i in `seq 0 640`; do
	$XFS_IO_PROG -f -c "pwrite 0 1M" "$SCRATCH_MNT/data/file$i" > /dev/null 2>&1
done

# Snapshot twice.
_run_btrfs_util_prog subvolume snapshot $SCRATCH_MNT "$SCRATCH_MNT/snaps/snap1"
_run_btrfs_util_prog subvolume snapshot $SCRATCH_MNT "$SCRATCH_MNT/snaps/snap2"

_scratch_unmount

# qgroup will be checked by fstest at _check_scratch_fs()
status=0
exit
